kind: pipeline
spec:
  stages:
  - type: ci
    spec:
      volumes:
        - name: dockersock
          type: host
          spec:
            path: /var/run/docker.sock

      steps:
      - name: build-and-run-audit
        type: run
        spec:
          container: 
            image: docker:latest
          envs:
            GH_PAT: ${{ secrets.get("gh_pat") }}
            SMTP_USER: ${{ secrets.get("smtp_user") }}
            SMTP_PASSWORD: ${{ secrets.get("smtp_password") }}
            SMTP_FROM: ${{ secrets.get("smtp_from") }}
          mount:
            - name: dockersock
              path: /var/run/docker.sock
          script: |
            set -e

            echo "=== Checking Docker ==="
            docker version
            docker info

            echo "=== Injecting Secrets ==="
            cp .env.example .env

            sed -i "s#__SECRET_GH_PAT__#${GH_PAT}#g" .env
            sed -i "s#__SECRET_SMTP_USER__#${SMTP_USER}#g" .env
            sed -i "s#__SECRET_SMTP_PASSWORD__#${SMTP_PASSWORD}#g" .env
            sed -i "s#__SECRET_SMTP_FROM__#${SMTP_FROM}#g" .env

            echo "=== Building Image ==="
            docker build -t github-audit:latest .

            docker run --rm --env-file .env github-audit:latest
            RC=$?
            echo "Container exited with $RC"
            exit $RC
